#!/bin/bash

echo "=========================================="
echo "  Network Monitor - Tests de validation"
echo "=========================================="
echo ""

# Fonction de test
test_step() {
    local name=$1
    local command=$2
    
    echo -n "üîç Test: $name ... "
    if eval "$command" &>/dev/null; then
        echo "‚úÖ OK"
        return 0
    else
        echo "‚ùå √âCHEC"
        return 1
    fi
}

# Compteur de tests
total=0
passed=0

# Tests des d√©pendances syst√®me
echo "--- Tests des d√©pendances syst√®me ---"
test_step "Docker install√©" "command -v docker" && ((passed++))
((total++))

test_step "Docker Compose install√©" "command -v docker-compose" && ((passed++))
((total++))

test_step "Python 3 disponible" "command -v python3" && ((passed++))
((total++))

echo ""
echo "--- Tests des outils r√©seau ---"
test_step "arp disponible" "command -v arp" && ((passed++))
((total++))

test_step "arp-scan disponible (optionnel)" "command -v arp-scan" && ((passed++)) || echo "‚ÑπÔ∏è  arp-scan n'est pas install√© (optionnel, arp sera utilis√©)"
((total++))

test_step "systemctl disponible" "command -v systemctl" && ((passed++))
((total++))

test_step "journalctl disponible" "command -v journalctl" && ((passed++))
((total++))

echo ""
echo "--- Tests des fichiers du projet ---"
test_step "app.py existe" "[ -f app.py ]" && ((passed++))
((total++))

test_step "Dockerfile existe" "[ -f Dockerfile ]" && ((passed++))
((total++))

test_step "docker-compose.yml existe" "[ -f docker-compose.yml ]" && ((passed++))
((total++))

test_step "templates/dashboard.html existe" "[ -f templates/dashboard.html ]" && ((passed++))
((total++))

test_step "requirements.txt existe" "[ -f requirements.txt ]" && ((passed++))
((total++))

echo ""
echo "--- Tests du conteneur Docker (si lanc√©) ---"
if docker ps | grep -q network_monitor; then
    test_step "Conteneur en cours d'ex√©cution" "docker ps | grep -q network_monitor" && ((passed++))
    ((total++))
    
    test_step "Port 5000 accessible" "curl -s -o /dev/null -w '%{http_code}' http://localhost:5000 | grep -q 200" && ((passed++))
    ((total++))
    
    test_step "API /api/data r√©pond" "curl -s http://localhost:5000/api/data | grep -q 'devices'" && ((passed++))
    ((total++))
    
    test_step "API /api/health r√©pond" "curl -s http://localhost:5000/api/health | grep -q 'ok'" && ((passed++))
    ((total++))
else
    echo "‚ÑπÔ∏è  Conteneur non lanc√©, d√©marrez avec: docker-compose up -d"
    total=$((total + 4))
fi

echo ""
echo "=========================================="
echo "üìä R√©sultats des tests"
echo "=========================================="
echo "‚úÖ Tests r√©ussis: $passed/$total"
echo "‚ùå Tests √©chou√©s: $((total - passed))/$total"

if [ $passed -eq $total ]; then
    echo ""
    echo "üéâ Tous les tests sont pass√©s !"
    echo "L'application est pr√™te √† √™tre utilis√©e."
    exit 0
elif [ $passed -ge $((total * 75 / 100)) ]; then
    echo ""
    echo "‚ö†Ô∏è  La plupart des tests sont OK, mais quelques probl√®mes d√©tect√©s."
    echo "L'application devrait fonctionner avec des limitations."
    exit 0
else
    echo ""
    echo "‚ùå Plusieurs tests ont √©chou√©."
    echo "V√©rifiez l'installation et les d√©pendances."
    exit 1
fi